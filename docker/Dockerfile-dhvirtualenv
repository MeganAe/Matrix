# A dockerfile which builds a docker image for building a debian package for
# synapse. The distro to build for is passed as a docker build var.
#
# The default entrypoint expects the synapse source to be mounted as a
# (read-only) volume at /synapse/source, and an output directory at /debs.
#
# A pair of environment variables (TARGET_USERID and TARGET_GROUPID) can be
# passed to the docker container; if these are set, the build script will chown
# the build products accordingly, to avoid ending up with things owned by root
# in the host filesystem.

# Get the distro we want to pull from as a dynamic build variable
ARG distro=""

###
### Stage 0: build a dh-virtualenv
### Based on https://github.com/spotify/dh-virtualenv/blob/master/Dockerfile
###

FROM ${distro} as builder

RUN apt-get update -qq -o Acquire::Languages=none \
    && env DEBIAN_FRONTEND=noninteractive apt-get install \
        -yqq --no-install-recommends -o Dpkg::Options::=--force-unsafe-io \
        build-essential debhelper devscripts equivs lsb-release \
        python3-setuptools \
        python3-sphinx python3-mock dh-exec dh-python python3-sphinx-rtd-theme \
    && if test "$(lsb_release -cs)" = 'bionic' ; then \
        apt-get install -yqq --no-install-recommends -o Dpkg::Options::=--force-unsafe-io \
                        -t bionic-backports debhelper; fi \
    && apt-get clean && rm -rf "/var/lib/apt/lists"/*

# fetch and unpack dh-virtualenv 1.2.2 (commit hash used to ensure integrity)
ADD https://github.com/spotify/dh-virtualenv/archive/96963cff2e569bf0a15933f773a8bea7a762e2c4.tar.gz /dh-virtualenv.tar.gz

RUN mkdir /dh-virtualenv \
    && cd /dh-virtualenv \
    && tar --strip-components=1 -xvf /dh-virtualenv.tar.gz \
    && dpkg-buildpackage -us -uc -b

###
### Stage 1
###
FROM ${distro}

# Get the distro we want to pull from as a dynamic build variable
# (We need to define it in each build stage)
ARG distro=""
ENV distro ${distro}

# Python < 3.7 assumes LANG="C" means ASCII-only and throws on printing unicode
# http://bugs.python.org/issue19846
ENV LANG C.UTF-8

COPY --from=builder /dh-virtualenv_*.deb /

# Install the build dependencies
#
# NB: keep this list in sync with the list of build-deps in debian/control
# TODO: it would be nice to do that automatically.
RUN apt-get update -qq -o Acquire::Languages=none \
    && env DEBIAN_FRONTEND=noninteractive apt-get install \
        -yqq --no-install-recommends -o Dpkg::Options::=--force-unsafe-io \
        build-essential \
        debhelper \
        dh-python \
        devscripts \
        libsystemd-dev \
        lsb-release \
        pkg-config \
        python3-dev \
        python3-pip \
        python3-setuptools \
        python3-venv \
        sqlite3 \
        libpq-dev \
        xmlsec1 \
        /dh-virtualenv_*.deb \
    && apt-get clean && rm -rf "/var/lib/apt/lists"/*

WORKDIR /synapse/source
ENTRYPOINT ["bash","/synapse/source/docker/build_debian.sh"]
