Fixes and optimisations for resolve_state_groups
