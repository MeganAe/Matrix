Convert groups and visibility code to async / await.
