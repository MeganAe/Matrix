Fixes #9635, and optimizes federation sending.