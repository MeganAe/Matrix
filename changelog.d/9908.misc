Speed up federation transmission by using fewer database calls. Contributed by @ShadowJonathan.
