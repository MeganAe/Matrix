Fix a long standing bug where Synapse would fail to handle malformed user IDs or room aliases gracefully in certain cases.
